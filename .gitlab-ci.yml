image: php:8.2-cli

services:
  - mysql:latest

variables:
  MYSQL_HOST: mysql
  MYSQL_DATABASE: user_auth
  MYSQL_USER: root
  MYSQL_PASSWORD: root
  MYSQL_ROOT_PASSWORD: root

cache:
  paths:
    - vendor/
    - ~/.composer/cache

before_script:
  # Install required system dependencies and PHP extensions
  - apt-get update && apt-get install -y unzip git libpq-dev libonig-dev default-mysql-client
  - docker-php-ext-install pdo_mysql
  - php --version

  # Ensure MySQL service is ready before proceeding
  - |
    echo "Waiting for MySQL to be ready..."
    until mysql -h mysql -u root -proot -e "SHOW DATABASES"; do
      echo "MySQL is not ready yet, waiting...";
      sleep 5;
    done

  # Ensure a valid php.ini exists
  - cp /usr/local/etc/php/php.ini-development /usr/local/etc/php/php.ini

stages:
  - install
  - test
  - build

install_dependencies:
  stage: install
  script:
    - curl -sS https://getcomposer.org/installer | php
    - php composer.phar install --prefer-dist --no-progress --ignore-platform-reqs
  artifacts:
    paths:
      - vendor/

run_tests:
  stage: test
  script:
    - echo "Running tests..."
    - php vendor/bin/phpunit --configuration phpunit.xml.dist
  only:
    - main

build:
  stage: build
  script:
    - echo "Building project..."
